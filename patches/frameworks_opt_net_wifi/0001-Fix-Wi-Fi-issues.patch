From 901947d01f684f4b28e5daafe9a7018076d1cd3c Mon Sep 17 00:00:00 2001
From: Epirex <estebanguzzo@gmail.com>
Date: Wed, 15 Jun 2016 20:52:09 -0300
Subject: [PATCH] Fix Wi-Fi issues

---
 .../server/wifi/WifiAutoJoinController.java        | 27 ++++------------------
 .../com/android/server/wifi/WifiStateMachine.java  |  5 +++-
 2 files changed, 9 insertions(+), 23 deletions(-)

diff --git a/service/java/com/android/server/wifi/WifiAutoJoinController.java b/service/java/com/android/server/wifi/WifiAutoJoinController.java
index e525949..b82cae3 100644
--- a/service/java/com/android/server/wifi/WifiAutoJoinController.java
+++ b/service/java/com/android/server/wifi/WifiAutoJoinController.java
@@ -57,12 +57,12 @@ public class WifiAutoJoinController {
     private WifiNetworkScoreCache mNetworkScoreCache;
 
     private static final String TAG = "WifiAutoJoinController ";
-    private static boolean DBG = false;
-    private static boolean VDBG = false;
+    private static boolean DBG = true;
+    private static boolean VDBG = true;
     private static final boolean mStaStaSupported = false;
 
-    public static int mScanResultMaximumAge = 40000; /* milliseconds unit */
-    public static int mScanResultAutoJoinAge = 5000; /* milliseconds unit */
+    public static int mScanResultMaximumAge = 400000000; /* milliseconds unit */
+    public static int mScanResultAutoJoinAge = 500000000; /* milliseconds unit */
 
     private String mCurrentConfigurationKey = null; //used by autojoin
 
@@ -75,7 +75,7 @@ public class WifiAutoJoinController {
     /**
      * Whether to allow connections to untrusted networks.
      */
-    private boolean mAllowUntrustedConnections = false;
+    private boolean mAllowUntrustedConnections = true;
 
     /* For debug purpose only: if the scored override a score */
     boolean didOverride = false;
@@ -1593,24 +1593,7 @@ public class WifiAutoJoinController {
             }
 
             // Try to un-blacklist based on elapsed time
-            if (config.blackListTimestamp > 0) {
-                if (now < config.blackListTimestamp) {
-                    /**
-                     * looks like there was a change in the system clock since we black listed, and
-                     * timestamp is not meaningful anymore, hence lose it.
-                     * this event should be rare enough so that we still want to lose the black list
-                     */
                     config.setAutoJoinStatus(WifiConfiguration.AUTO_JOIN_ENABLED);
-                } else {
-                    if ((now - config.blackListTimestamp) > loseBlackListHardMilli) {
-                        // Reenable it after 18 hours, i.e. next day
-                        config.setAutoJoinStatus(WifiConfiguration.AUTO_JOIN_ENABLED);
-                    } else if ((now - config.blackListTimestamp) > loseBlackListSoftMilli) {
-                        // Lose blacklisting due to bad link
-                        config.setAutoJoinStatus(config.autoJoinStatus - 8);
-                    }
-                }
-            }
 
             if (config.visibility == null) {
                 continue;
diff --git a/service/java/com/android/server/wifi/WifiStateMachine.java b/service/java/com/android/server/wifi/WifiStateMachine.java
index 1c06e71..aba9278 100644
--- a/service/java/com/android/server/wifi/WifiStateMachine.java
+++ b/service/java/com/android/server/wifi/WifiStateMachine.java
@@ -5811,7 +5811,10 @@ public class WifiStateMachine extends StateMachine implements WifiNative.WifiPno
                     maybeRegisterNetworkFactory();
                     break;
                 case CMD_SCREEN_STATE_CHANGED:
-                    handleScreenStateChanged(message.arg1 != 0);
+                    WifiManager manager = (WifiManager)mContext.getSystemService(Context.WIFI_SERVICE);
+                    if(manager.isWifiEnabled()) {
+                        handleScreenStateChanged(message.arg1 != 0);
+                    }
                     break;
                     /* Discard */
                 case CMD_START_SCAN:
-- 
2.5.0

